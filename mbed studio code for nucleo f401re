#include "mbed.h"
#include "ArduinoJson.h"

BufferedSerial serial_port(USBTX, USBRX, 115200);
DigitalOut led(LED1);
float temperature = 25.0;  // Initial temperature

void send_json()
{
    // Simulate temperature changes
    temperature += (rand() % 3 - 1) * 0.5;  // Random +/-0.5 change

    StaticJsonDocument<200> doc;
    doc["temperature"] = temperature;
    doc["led_status"] = led ? "on" : "off";

    char buffer[200];
    size_t length = serializeJson(doc, buffer);

    serial_port.write(buffer, length);
    serial_port.write("\n", 1);  
}

void read_serial()
{
    char received[100] = {0};
    int len = serial_port.read(received, sizeof(received));

    if (len > 0) {
        received[len] = '\0';  
        StaticJsonDocument<100> doc;
        DeserializationError error = deserializeJson(doc, received);

        if (!error) {
            if (doc["command"] == "toggle_led") {
                led = !led;  
            }
        }
    }
}

int main()
{
    serial_port.set_blocking(false);
    while (true) {
        send_json();
        read_serial();
        ThisThread::sleep_for(300ms);  
    }
}
